"""
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é.
"""
import asyncio
import logging
from datetime import datetime

from aiogram import Bot

from .stats import stats_manager

logger = logging.getLogger(__name__)


async def reminders_background_task(bot: Bot):
    """
    –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
    
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (7+ –¥–Ω–µ–π)
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.
    
    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    """
    CHECK_INTERVAL_HOURS = 24  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏
    INACTIVE_DAYS = 7  # –ù–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 7+ –¥–Ω–µ–π
    
    logger.info(
        f"‚ñ∂Ô∏è –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–∞ "
        f"(–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ {CHECK_INTERVAL_HOURS}—á, –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å {INACTIVE_DAYS} –¥–Ω–µ–π)"
    )
    
    while True:
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            inactive_users = await stats_manager.get_inactive_users(days=INACTIVE_DAYS)
            
            if inactive_users:
                logger.info(f"üì® –ù–∞–π–¥–µ–Ω–æ {len(inactive_users)} –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
                
                sent_count = 0
                for user_id in inactive_users:
                    try:
                        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                        message = (
                            "üëã –ü—Ä–∏–≤–µ—Ç! –¢–µ–±—è –¥–∞–≤–Ω–æ –Ω–µ –±—ã–ª–æ –≤–∏–¥–Ω–æ.\n\n"
                            "–ù–µ –∂–µ–ª–∞–µ—à—å –ø—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è?\n\n"
                            "–ó–∞—Ö–æ–¥–∏ —Å–∫–æ—Ä–µ–π –∏ –∂–º–∏ /start! üöÄ"
                        )
                        
                        await bot.send_message(user_id, message)
                        
                        # –û—Ç–º–µ—á–∞–µ–º –≤ –ë–î
                        await stats_manager.mark_reminder_sent(user_id)
                        
                        sent_count += 1
                        logger.info(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
                        
                    except Exception as e:
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ {user_id}: {e}")
                    
                    # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏ (–∞–Ω—Ç–∏—Å–ø–∞–º)
                    await asyncio.sleep(1)
                
                logger.info(f"‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count}/{len(inactive_users)} –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")
            else:
                logger.debug(f"‚ÑπÔ∏è –ù–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ({INACTIVE_DAYS} –¥–Ω–µ–π)")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π: {e}", exc_info=True)
        
        # –ñ–¥—ë–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (24 —á–∞—Å–∞)
        await asyncio.sleep(CHECK_INTERVAL_HOURS * 3600)
